name: Rails CI/CD

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Deploy
      env:
        PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        USER_NAME: ${{ secrets.USER_NAME }}
        HOST_NAME: ${{ secrets.HOST_NAME }}
      run: |
        # ç§˜å¯†éµä½œæˆ
        echo "$PRIVATE_KEY" > private_key
        chmod 600 private_key

        # EC2 ã« SSH æŽ¥ç¶šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
        ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOST_NAME} '
          # ç’°å¢ƒå¤‰æ•°
          export RAILS_ENV=production
          
          # nvm ã‚’ãƒ­ãƒ¼ãƒ‰
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm use 20

          # ã‚¢ãƒ—ãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
          cd ~/game_review_app

          # æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          git fetch origin main
          git reset --hard origin/main

          # Ruby gems ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          bundle install --deployment --without development test

          # JavaScript / CSS ã‚¢ã‚»ãƒƒãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
          RAILS_ENV=production bundle exec rails assets:precompile

          # DB ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          RAILS_ENV=production bundle exec rails db:migrate

          # å¿…è¦ãªã‚‰Seedãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆæœ¬ç•ªç’°å¢ƒç”¨ï¼‰
          # RAILS_ENV=production bundle exec rails db:seed

          # tmpãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™è¨­å®š
          mkdir -p tmp/sockets tmp/pids
          chmod 755 tmp tmp/sockets tmp/pids

          # Pumaã‚’å†èµ·å‹•ï¼ˆsystemdã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹å ´åˆï¼‰
          if systemctl list-unit-files | grep -q puma.service; then
            echo "ðŸ”§ systemdã§Pumaã‚’å†èµ·å‹•ã—ã¾ã™..."
            sudo systemctl restart puma
          else
            echo "âš ï¸ systemdã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§Pumaã‚’èµ·å‹•ã—ã¾ã™..."
            # æ—¢å­˜ã®Pumaãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
            pkill -f puma || true
            # æ–°ã—ã„Pumaã‚’èµ·å‹•
            RAILS_ENV=production bundle exec puma -C config/puma.rb -d
          fi

          # Nginxã‚’å†èµ·å‹•
          echo "ðŸ”§ Nginxã‚’å†èµ·å‹•ã—ã¾ã™..."
          sudo systemctl restart nginx

          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          echo "ðŸ“Š ã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª:"
          sudo systemctl status puma --no-pager || echo "Puma service not found"
          sudo systemctl status nginx --no-pager

          # socketãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ðŸ“ Socketãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          ls -la tmp/sockets/ 2>/dev/null || echo "tmp/sockets directory not found"

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        '